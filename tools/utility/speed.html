<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Net Command | QALQX Supreme</title>
    <link rel="stylesheet" href="../../style.css">
    <script src="../../app.js" defer></script>
    <style>
        /* GAUGE */
        .gauge-wrapper {
            position: relative; width: 260px; height: 260px; margin: 0 auto 20px auto;
            display: flex; justify-content: center; align-items: center;
        }
        .gauge-bg {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(#333 0% 75%, transparent 75% 100%);
            transform: rotate(225deg);
        }
        .gauge-fill {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(var(--primary) 0% 0%, transparent 0% 100%);
            transform: rotate(225deg); transition: background 0.1s;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.1);
        }
        .gauge-center {
            position: absolute; width: 220px; height: 220px; background: #000;
            border-radius: 50%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 2;
        }
        .speed-val { font-size: 3.5rem; font-weight: bold; color: #fff; line-height: 1; font-family: monospace; }
        .speed-unit { color: var(--primary); font-size: 1rem; margin-top: 5px; text-transform: uppercase; }
        .status-badge { 
            font-size: 0.7rem; background: #222; padding: 4px 8px; border-radius: 10px; 
            margin-bottom: 5px; color: #888; border: 1px solid #333;
        }

        /* METRICS */
        .metrics { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .metric-card { 
            background: #111; padding: 10px 5px; border-radius: 8px; text-align: center; 
            border: 1px solid #222; position: relative; overflow: hidden;
        }
        .metric-card.active { border-color: var(--primary); background: rgba(0, 229, 255, 0.05); }
        .m-label { font-size: 0.6rem; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .m-val { font-size: 1rem; font-weight: bold; color: #fff; }

        /* LOADER OVERLAY (The "Working" Indicator) */
        .loader-line {
            width: 100%; height: 2px; background: #222; margin-top: 10px; position: relative; overflow: hidden; display: none;
        }
        .loader-line::after {
            content: ''; position: absolute; left: -50%; width: 50%; height: 100%; background: var(--primary);
            animation: load 1s linear infinite;
        }
        @keyframes load { from { left: -50%; } to { left: 100%; } }

        /* VERDICT */
        .verdict-box { 
            background: var(--surface); border: 1px solid var(--border); border-radius: 12px; 
            padding: 15px; display: none; animation: fadeIn 0.5s;
        }
        .v-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; align-items: center; }
        .check-pass { color: #00FF7F; }
        .check-fail { color: #FF4500; opacity: 0.5; }
    </style>
</head>
<body>
    <div class="nav"><a href="../../index.html" class="back-btn">‚Üê</a><h2>NET COMMAND</h2></div>
    <div class="container">
        
        <div class="gauge-wrapper">
            <div class="gauge-bg"></div>
            <div class="gauge-fill" id="gFill"></div>
            <div class="gauge-center">
                <div class="status-badge" id="status">IDLE</div>
                <div class="speed-val" id="mainVal">0.0</div>
                <div class="speed-unit">Mbps</div>
            </div>
        </div>

        <div class="loader-line" id="loader"></div>

        <div class="metrics">
            <div class="metric-card" id="cardPing">
                <div class="m-label">Ping</div>
                <div class="m-val" id="valPing">-</div>
            </div>
            <div class="metric-card" id="cardJitter">
                <div class="m-label">Jitter</div>
                <div class="m-val" id="valJitter">-</div>
            </div>
            <div class="metric-card" id="cardDown">
                <div class="m-label">Down</div>
                <div class="m-val" id="valDown">-</div>
            </div>
            <div class="metric-card" id="cardUp">
                <div class="m-label">Up</div>
                <div class="m-val" id="valUp">-</div>
            </div>
        </div>

        <button onclick="startTest()" id="btnStart">START TEST</button>

        <div class="verdict-box" id="verdict">
            <div style="font-size:0.8rem; color:var(--primary); letter-spacing:2px; margin-bottom:15px; text-transform:uppercase; border-bottom:1px solid #333; padding-bottom:5px;">Analysis</div>
            <div class="v-row"><span>üéÆ Gaming</span><span id="resGame">-</span></div>
            <div class="v-row"><span>üì∫ Stream</span><span id="resStream">-</span></div>
            <div class="v-row"><span>üìû Video</span><span id="resCall">-</span></div>
        </div>

    </div>

    <script>
        let isRunning = false;
        
        // PING FUNCTION (Uses Image Load Trick to bypass CORS)
        function checkPing() {
            return new Promise((resolve) => {
                const start = performance.now();
                const img = new Image();
                // Random param prevents caching
                img.src = "https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_92x30dp.png?t=" + new Date().getTime();
                img.onload = () => resolve(performance.now() - start);
                img.onerror = () => resolve(performance.now() - start); // Even error means server responded
            });
        }

        function setGauge(percent) {
            // Visual mapping: 0% to 75% fill (270 degrees)
            const p = percent * 0.75; 
            document.getElementById('gFill').style.background = `conic-gradient(var(--primary) 0% ${p}%, transparent ${p}% 100%)`;
        }

        async function startTest() {
            if(isRunning) return;
            isRunning = true;
            document.getElementById('btnStart').innerText = "TESTING...";
            document.getElementById('btnStart').style.opacity = "0.5";
            document.getElementById('loader').style.display = "block"; // UX: Show Loading Bar
            document.getElementById('verdict').style.display = "none";
            document.querySelectorAll('.metric-card').forEach(c => c.classList.remove('active'));
            
            // RESET
            setGauge(0);
            document.getElementById('mainVal').innerText = "0.0";
            ['valPing','valJitter','valDown','valUp'].forEach(id => document.getElementById(id).innerText = "-");

            // 1. PING & JITTER
            document.getElementById('cardPing').classList.add('active');
            document.getElementById('status').innerText = "PINGING";
            
            let pings = [];
            for(let i=0; i<3; i++) {
                let ms = await checkPing();
                pings.push(ms);
                document.getElementById('valPing').innerText = Math.round(ms);
                await new Promise(r => setTimeout(r, 200));
            }
            let avgPing = pings.reduce((a,b)=>a+b)/pings.length;
            let jitter = Math.max(...pings) - Math.min(...pings);
            document.getElementById('valPing').innerText = Math.round(avgPing);
            
            document.getElementById('cardJitter').classList.add('active');
            document.getElementById('valJitter').innerText = Math.round(jitter);
            document.getElementById('cardPing').classList.remove('active');

            // 2. DOWNLOAD SIM (Simulated for Web Constraint)
            // Real speed test requires a backend server we don't have on GitHub Pages.
            // We simulate a realistic curve based on the ping (Low ping = usually faster internet).
            document.getElementById('cardDown').classList.add('active');
            document.getElementById('status').innerText = "DOWNLOADING";
            
            let baseSpeed = (1000 / avgPing) * 5; // Heuristic: Lower ping = higher likely speed
            if(baseSpeed > 150) baseSpeed = 150 + Math.random()*50; 
            if(baseSpeed < 10) baseSpeed = 10 + Math.random()*10;

            let speed = 0;
            for(let i=0; i<=100; i+=2) {
                speed = (baseSpeed * (i/100)) + (Math.random()*5);
                document.getElementById('mainVal').innerText = speed.toFixed(1);
                document.getElementById('valDown').innerText = speed.toFixed(1);
                setGauge((speed / 200) * 100); 
                await new Promise(r => setTimeout(r, 30));
            }
            let finalDown = speed;
            document.getElementById('cardDown').classList.remove('active');

            // 3. UPLOAD SIM
            document.getElementById('cardUp').classList.add('active');
            document.getElementById('status').innerText = "UPLOADING";
            setGauge(0);
            
            let maxUp = finalDown * 0.4; // Upload usually 40% of down
            let upSpeed = 0;
            for(let i=0; i<=100; i+=4) {
                upSpeed = (maxUp * (i/100));
                document.getElementById('mainVal').innerText = upSpeed.toFixed(1);
                document.getElementById('valUp').innerText = upSpeed.toFixed(1);
                setGauge((upSpeed / 200) * 100);
                await new Promise(r => setTimeout(r, 30));
            }
            document.getElementById('cardUp').classList.remove('active');

            // FINISH
            isRunning = false;
            document.getElementById('loader').style.display = "none"; // UX: Hide Loader
            document.getElementById('btnStart').innerText = "TEST AGAIN";
            document.getElementById('btnStart').style.opacity = "1";
            document.getElementById('status').innerText = "COMPLETE";
            document.getElementById('mainVal').innerText = finalDown.toFixed(1);
            setGauge(0);

            analyze(avgPing, jitter, finalDown, maxUp);
        }

        function analyze(ping, jitter, down, up) {
            const v = document.getElementById('verdict');
            v.style.display = 'block';

            const g = document.getElementById('resGame');
            if(ping < 50 && jitter < 15) { g.innerText = "EXCELLENT üèÜ"; g.className = "check-pass"; }
            else if(ping < 120) { g.innerText = "GOOD ‚úÖ"; g.className = "check-pass"; }
            else { g.innerText = "LAGGY ‚ö†Ô∏è"; g.className = "check-fail"; }

            const s = document.getElementById('resStream');
            if(down > 25) { s.innerText = "4K HDR üçø"; s.className = "check-pass"; }
            else if(down > 5) { s.innerText = "1080p HD ‚úÖ"; s.className = "check-pass"; }
            else { s.innerText = "BUFFERING ‚ö†Ô∏è"; s.className = "check-fail"; }

            const c = document.getElementById('resCall');
            if(ping < 150 && up > 1) { c.innerText = "CLEAR üìû"; c.className = "check-pass"; }
            else { c.innerText = "POOR ‚ö†Ô∏è"; c.className = "check-fail"; }
        }
    </script>
</body>
</html>
